# Android Kotlin / 基本概念 / 資料持續性 - Notes

Update: 2022/07/18
Update: 2022/07/22

* [SQL、Room和Flow簡介](#sqlroom和flow簡介-br)
* [使用Room保存資料](#使用room保存資料-br)
* [Reference](#reference-br)

---

## SQL、Room和Flow簡介 <br/>

#### SQL 基本資料

> 主鍵

    唯一識別碼，此專屬ID可協助查詢、更新及刪除資料表中的現有項目

> Room

    2017年Google提供的組件，用來儲存本地端資料。
    提供比SQLite更簡潔、快速的Database操作。

* Entity + DAO + Database
* Entity

    - 至少需要一個參數當PrimaryKey
    - 可透過 autoGenerate 決定是否自動生成id

    ```
    @Entity(tableName = TABLE_NAME)
    class RoomEntity {

        companion object {
            const val TABLE_NAME = "room_entity"
        }

        @PrimaryKey(autoGenerate = true)
        var id: Int = 0
        var name: String = ""
        
    }
    ```

* DAO

    ```
    CRUD interface
    ```

    - @Insert
    - @Query
    - @Delete
    - @Update

* Database

    必須繼承 RoomDatabase<br/>
    官方建議使用 Singleton 寫法

<br/>

> Android Studio 資料庫檢查器

    Android Studio Chipmunk | 2021.2.1

* View > Tool Windows > App Inspection
* 選擇 Database Inspector
* Open New Query Tab，可在此輸入sql command 執行

<br/>

> Companion Object (伴生物件)

    以下情況時可使用，companion object
    1. 不希望此 class 為 singleton
    2. 需要靜態區塊時

    PS. 因 Kotlin 無 static

> @Database
```
    @Database(entities = arrayOf(Schedule::class), version = 1)
```

- Schedule: 可帶入對應的 Database 名稱 
- version: Dtabase 有變更時需要 + 1

<br/>

> Flow
```
    asynchronous flow 的 kotlin 功能
```

<br/>

> ORM
```
    Object Relation Mapping (物件關聯對應)
```
- 可以降低程式與資料庫之間的耦合

<br/>

> 常用
* COUNT
    ```
    SELECT COUNT(type)
    FROM park
    ```
* SUM
    ```
    SELECT SUM(park_visitors) total
    FROM park
    ```
* DISTINCT
    ```
    SELECT DISTINCT type
    FROM park
    ```
<br/>

---

## 使用Room保存資料 <br/>

```
1. Room 是 Android Jetpack 中的持續性程式庫
2. Room 是 SQLite 頂端的抽象層
```

> Implement Flow

- Entity
- DAO
- Database
- Application generate Database

<br/>

> DAO Insert onConflic

    設定當insert資料衝突時，如何處理

- REPLACE (替換，繼續執行)
- ABORT (不替換，結束執行)
- IGNORE (不替換，繼續執行)

<br/>

Example：
```
    @Insert(onConflic = OnConflicStrategy.IGNORE )
    suspend fun insert(item: Item)
```

<br/>

> 如要透過主執行緒與資料庫互動

- 啟動協同程式執行 DAO fun

```
    透過 viewModel.scope 啟動協同程式
```

<br/>

---

## Reference <br/>

* https://developer.android.com/codelabs/basic-android-kotlin-training-sql-basics?hl=zh-tw&continue=https%3A%2F%2Fdeveloper.android.com%2Fcourses%2Fpathways%2Fandroid-basics-kotlin-unit-5-pathway-1%3Fhl%3Dzh-tw%23codelab-https%3A%2F%2Fdeveloper.android.com%2Fcodelabs%2Fbasic-android-kotlin-training-sql-basics#1

* https://ithelp.ithome.com.tw/articles/10223511
(Room)

* https://ithelp.ithome.com.tw/articles/10234820
(ORM)

* https://blog.csdn.net/vitaviva/article/details/112721321
(Insert onConflic)



